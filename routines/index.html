
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://jeremyfix.github.io/Architecture/routines/">
      
      
        <link rel="prev" href="../seq_micro/">
      
      
        <link rel="next" href="../irq/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Pile et appel de routines (TP 3) - Architecture des ordinateurs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-grey">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pile-et-appel-de-routines-tp-3" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href=".." title="Architecture des ordinateurs" class="md-header__button md-logo" aria-label="Architecture des ordinateurs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Architecture des ordinateurs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pile et appel de routines (TP 3)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue-grey"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Recherche">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/jeremyfix/architecture" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Architecture des ordinateurs" class="md-nav__button md-logo" aria-label="Architecture des ordinateurs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Architecture des ordinateurs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jeremyfix/architecture" title="Aller au dépôt" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accueil
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../seq_man/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Séquenceur manuel (TP 1)
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../seq_micro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Séquence micro-programmé (TP 2)
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Pile et appel de routines (TP 3)
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Pile et appel de routines (TP 3)
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#instructions-de-manipulation-de-la-pile-et-de-son-pointeur-peek-push-pop-incsp-et-decsp" class="md-nav__link">
    <span class="md-ellipsis">
      Instructions de manipulation de la pile et de son pointeur PEEK, PUSH, POP, INCSP et DECSP
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instructions-de-depart-et-retour-de-routines-call-et-ret" class="md-nav__link">
    <span class="md-ellipsis">
      Instructions de départ et retour de routines CALL et RET
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../irq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Interruptions (TP 4)
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ordonnanceur/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Programmation assembleur et ordonnancement (TP 5)
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../spaceinvaders/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bonus: place aux jeux
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<div><h1 id="pile-et-appel-de-routines-tp-3">Pile et appel de routines (TP 3)</h1>
<p>Le but de ce BE est d'étudier une extension de l'architecture des séances précédentes pour gérer l'appel de sous-programmes. On va voir notamment:</p>
<ul>
<li>le registre Stack Pointer (SP) et la zone mémoire réservée à la pile dans la RAM</li>
<li>les instructions permettant de manipuler la pile</li>
<li>le codage en language assembleur et l'exécution de fonctions récursives</li>
</ul>
<p>L'architecture que je vous propose d'utiliser est représentée ci-dessous. Vous y verrez notamment l'ajout d'un registre (<strong>Stack Pointer</strong>) ainsi que deux signaux de contrôle <ins class="critic">SetSP</ins> et <ins class="critic">ReadSP</ins> qui permettent l'accès en lecture et écriture du registre. </p>
<p>Téléchargez le fichier <a href="https://raw.githubusercontent.com/jeremyfix/Architecture/refs/heads/main/TP-Evolution/archi_routines.circ">archi_routines.circ</a> ainsi que le fichier <a href="../assets/csmetz.jar">csmetz.jar</a> à placer dans le même répertoire que votre circuit. Ouvrez le circuit avec logisim. Chargez la ROM <a href="https://raw.githubusercontent.com/jeremyfix/Architecture/refs/heads/main/TP-Evolution/Microcodes/microcode_routines.rom">microcode_routines.rom</a> qui contient les micro-instructions des instructions introduites dans le sujet précédent.</p>
<p>Je vous rappelle que vous disposez de <a href="../assets/reference_card.pdf">la carte de référence de l'architecture</a>. </p>
<p><a class="glightbox" href="../assets/archi_routines.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Architecture avec le registre de pointeur de pile" src="../assets/archi_routines.png"></a></p>
<h2 id="instructions-de-manipulation-de-la-pile-et-de-son-pointeur-peek-push-pop-incsp-et-decsp">Instructions de manipulation de la pile et de son pointeur <code>PEEK</code>, <code>PUSH</code>, <code>POP</code>, <code>INCSP</code> et <code>DECSP</code></h2>
<p>Le registre de pile (SP , Stack Pointer) est introduit dans le chemin de données. On introduit également de nouvelles instructions qui permettent de gérer la pile.</p>
<table>
<thead>
<tr>
<th>Code Instruction (8 bits)</th>
<th>Nom de l'instruction</th>
<th>Nombre de mots</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x80</td>
<td>LDSPi</td>
<td>2</td>
<td>Charge la valeur de l'opérande dans le registre SP. <br><ins class="critic">SP := opérande</ins>.</td>
</tr>
<tr>
<td>0x84</td>
<td>LDSPd</td>
<td>2</td>
<td>Charge la valeur dans la RAM pointée par l'opérande dans le registre SP. <br><ins class="critic">SP := Mem[opérande</ins>.</td>
</tr>
<tr>
<td>0x8c</td>
<td>STSP</td>
<td>2</td>
<td>Sauvegarde en mémoire la valeur du registre SP à l'adresse donnée par l'opérande. <br><ins class="critic">Mem[opérande] := SP</ins></td>
</tr>
<tr>
<td>0x90</td>
<td>INCSP</td>
<td>1</td>
<td>Incrémente le pointeur de pile. <br><ins class="critic">SP := SP + 1</ins></td>
</tr>
<tr>
<td>0x94</td>
<td>DECSP</td>
<td>1</td>
<td>Décrémente le pointeur de pile. <br><ins class="critic">SP := SP - 1</ins></td>
</tr>
<tr>
<td>0xb0</td>
<td>PUSHA</td>
<td>1</td>
<td>Empile le registre A. <br><ins class="critic">Mem[SP] := A; SP := SP - 1</ins></td>
</tr>
<tr>
<td>0xb4</td>
<td>POPA</td>
<td>1</td>
<td>Dépile le registre A. <br><ins class="critic">SP := SP + 1; A := Mem[SP]</ins></td>
</tr>
<tr>
<td>0xb8</td>
<td>POKEA</td>
<td>2</td>
<td>Sauvegarde le registre A dans la pile. <br><ins class="critic">Mem[SP+operande] := A</ins></td>
</tr>
<tr>
<td>0xbc</td>
<td>PEEKA</td>
<td>2</td>
<td>Récupère le registre A dans la pile. <br><ins class="critic">A := Mem[SP + operande]</ins></td>
</tr>
<tr>
<td>0xc0</td>
<td>PUSHB</td>
<td>1</td>
<td>Empile le registre B. <br><ins class="critic">Mem[SP] := B; SP := SP - 1</ins></td>
</tr>
<tr>
<td>0xc4</td>
<td>POPB</td>
<td>1</td>
<td>Dépile le registre B. <br><ins class="critic">SP := SP + 1; B := Mem[SP]</ins></td>
</tr>
<tr>
<td>0xc8</td>
<td>POKEB</td>
<td>2</td>
<td>Sauvegarde le registre B dans la pile. <br><ins class="critic">Mem[SP+operande] := B</ins></td>
</tr>
<tr>
<td>0xcc</td>
<td>PEEKB</td>
<td>2</td>
<td>Récupère le registre B dans la pile. <br><ins class="critic">B := Mem[SP + operande]</ins></td>
</tr>
</tbody>
</table>
<p>Il est important de s'assurer qu'après chaque instruction (non pas micro-instruction bien sûr), le pointeur de pile pointe la prochaine zone mémoire libre de la pile. Je vous rappelle aussi que la pile augmente dans le sens des adresses décroissantes; c'est la raison pour laquelle, par exemple, récupérer une variable dans la pile (PEEKA ou PEEKB) se fait en ajoutant un décalage au pointeur de pile. Tout ça est illustré ci-dessous. </p>
<p><a class="glightbox" href="../assets/stack.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Illustration des instructions Push, Pop, Poke et Peek" src="../assets/stack.png"></a></p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Ecrivez les micro-instructions des instructions ci-dessus. </p>
<p>Pour faciliter votre travail, je vous propose ci-dessous un outil qui permet de passer des signaux de contrôle du chemin de données au code hexadécimal de la micro-instruction et vice-versa. </p>
<p><button id="showTableBtn" class="md-button md-button--primary">Table de génération de micro-instructions</button></p>
<p>Vous remarquerez l'introduction de deux champs pour contrôler le registre de pointeur de pile (SP). </p>
</div>
<script>
document.getElementById('showTableBtn').onclick = function() {
    var dataId = 1;
    var dataSp = 1;
    var dataINT = 0;
    console.log("dataid from main: " + dataId);
    openTable(dataId, dataSp, dataINT);
};
</script>

<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Testez votre architecture avec le programme <a href="https://raw.githubusercontent.com/jeremyfix/Architecture/refs/heads/main/TP-Evolution/Progs/stack.mem">stack.mem</a>. Si tout se passe bien, vos afficheurs et votre RAM (regardez bien les adresses 0x1e, 0x1f et 0x20) devraient donner : </p>
<p><a class="glightbox" href="../assets/archi_routines_stack.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Résultat attendu de stack.mem" src="../assets/archi_routines_stack.png"></a></p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>N'hésitez pas à retranscrire le code machine en utilisant le nom des opérations pour plus facilement découvrir ce que ces programmes doivent faire. Par exemple :</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>8000 20
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>9400
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>1000 3
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>1c00 1000
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>b000
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>... 
</span></code></pre></div>
<p>peut se voir de manière équivalente comme :</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nf">LDSPi</span><span class="w"> </span><span class="mi">0x0020</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nf">DECSP</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="nf">LDAi</span><span class="w">  </span><span class="mi">0x0003</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nf">STA</span><span class="w">   </span><span class="mi">0x1000</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="nf">PUSHA</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="na">...</span>
</span></code></pre></div>
</div>
<h2 id="instructions-de-depart-et-retour-de-routines-call-et-ret">Instructions de départ et retour de routines <code>CALL</code> et <code>RET</code></h2>
<p>On va maintenant voir une utilisation intéressante de la pile lors de l'appel de routines, et en particulier le passage d'arguments et de la valeur de retour d'une routine. Il nous suffit d'introduire deux instructions pour l'appel d'une routine (<ins class="critic">CALL</ins>) et le retour d'une routine (<ins class="critic">RET</ins>) : </p>
<table>
<thead>
<tr>
<th>Code Instruction (8 bits)</th>
<th>Nom de l'instruction</th>
<th>Nombre de mots</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0xa0</td>
<td>CALL</td>
<td>2</td>
<td>Empile le compteur de programme (PC) et branche à l'adresse de la routine fournie par l'opérande</td>
</tr>
<tr>
<td>0xa8</td>
<td>RET</td>
<td>2</td>
<td>Dépile le compteur de programme (PC) de la pile</td>
</tr>
</tbody>
</table>
<p>Pour se rappeler la manière dont l'appel de routine fonctionne, je vous propose de considérer l'appel d'une fonction :</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>f(a, b) = a + b
</span></code></pre></div>
<p>Cette fonction doit disposer des opérandes "a" et "b", calculer son opération et retourner le résultat au programme appelant. En supposant par example que le programme appelant appelle f(7,8), on aurait par exemple le code suivant en RAM, ici écrit en assembleur pour être plus lisible:</p>
<div class="language-asm highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Programme appelant :</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="err">0</span><span class="nf">x0000</span><span class="w">     </span><span class="no">LDSPi</span><span class="w"> </span><span class="mi">0x0030</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="err">0</span><span class="nf">x0002</span><span class="w">     </span><span class="no">DECSP</span><span class="w">          </span><span class="c1"># On réserve de la place dans la pile pour la valeur de retour</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="err">0</span><span class="nf">x0003</span><span class="w">     </span><span class="no">LDAi</span><span class="w">  </span><span class="mi">0x0007</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="err">0</span><span class="nf">x0005</span><span class="w">     </span><span class="no">PUSHA</span><span class="w">          </span><span class="c1"># On charge la première opérande</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="err">0</span><span class="nf">x0006</span><span class="w">     </span><span class="no">LDAi</span><span class="w">  </span><span class="mi">0x0008</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="err">0</span><span class="nf">x0008</span><span class="w">     </span><span class="no">PUSHA</span><span class="w">          </span><span class="c1"># On charge la deuxième opérande</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="err">0</span><span class="nf">x0009</span><span class="w">     </span><span class="no">CALL</span><span class="w"> </span><span class="mi">0x0020</span><span class="w">    </span><span class="c1"># On appelle la routine</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="err">0</span><span class="nf">x000b</span><span class="w">     </span><span class="no">POPA</span><span class="w">           </span><span class="c1"># On enlève la deuxième opérande de la pile</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="err">0</span><span class="nf">x000c</span><span class="w">     </span><span class="no">POPA</span><span class="w">           </span><span class="c1"># On enlève la première opérande de la pile</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="err">0</span><span class="nf">x000d</span><span class="w">     </span><span class="no">POPA</span><span class="w">           </span><span class="c1"># On récupère le résultat</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="err">0</span><span class="nf">x000e</span><span class="w">     </span><span class="no">STA</span><span class="w">  </span><span class="mi">0x1000</span><span class="w">    </span><span class="c1"># On affiche le résultat</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="err">0</span><span class="nf">x0010</span><span class="w">     </span><span class="no">END</span><span class="w">            </span><span class="c1"># Fin de programme</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="c1"># Routine à l'adresse 0x0020:</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="err">0</span><span class="nf">x0020</span><span class="w">     </span><span class="no">PEEKA</span><span class="w"> </span><span class="mi">0x0003</span><span class="w">   </span><span class="c1"># On récupère la première opérande</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="err">0</span><span class="nf">x0022</span><span class="w">     </span><span class="no">PEEKB</span><span class="w"> </span><span class="mi">0x0002</span><span class="w">   </span><span class="c1"># On récupère la seconde opérande</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="err">0</span><span class="nf">x0024</span><span class="w">     </span><span class="no">ADDA</span><span class="w">           </span><span class="c1"># On en fait la somme</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="err">0</span><span class="nf">x0025</span><span class="w">     </span><span class="no">POKEA</span><span class="w"> </span><span class="mi">0x0004</span><span class="w">   </span><span class="c1"># On sauvegarde le résultat</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="err">0</span><span class="nf">x0027</span><span class="w">     </span><span class="no">RET</span><span class="w">            </span><span class="c1"># On retourne au programme appelant</span>
</span></code></pre></div>
<p>Pour qu'à la sortie de la routine (RET), on sache quelle adresse charger dans le compteur de programme (PC), l'instruction CALL sauvegarde la valeur courante du PC après avoir lu son opérande, i.e. l'adresse de l'instruction qui suit le CALL. Il faut bien faire attention à prendre en compte que l'adresse de retour est mise dans la pile lorsqu'on calcule les décalages des instructions PEEK et POKE. En image, ça nous donne une évolution de la pile ci-dessous :</p>
<p><a class="glightbox" href="../assets/stack_call_ret.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="Déroulement d'un appel et retour de routine" src="../assets/stack_call_ret.png"></a></p>
<p>L'adresse de retour empilée par le CALL est la valeur du PC après lecture de l'opérande du CALL. Lorsqu'on exécute les micro-instructions du CALL, le PC pointe sur son opérande; Faites donc bien attention à sauvegarder l'adresse de retour PC+1 dans la pile. </p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Je vous propose le travail suivant :</p>
<ul>
<li>introduisez les micro-instructions pour les instructions CALL (0xa0) et RET (0xa8),</li>
<li>programmez votre RAM pour exécuter l'exemple illustratif ci-dessus et tester votre implémentation.</li>
</ul>
<p>Pour vous aider dans votre travail , pensez à utiliser la :</p>
<p><button id="showTableBtn2" class="md-button md-button--primary">Table de génération de micro-instructions</button></p>
</div>
<script>
document.getElementById('showTableBtn2').onclick = function() {
    var dataId = 2;
    var dataSp = 1;
    var dataINT = 0;
    console.log("dataid from main: " + dataId);
    openTable(dataId, dataSp, dataINT);
};
</script>

<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Assurez vous que vos implémentations des instructions <code>CALL</code> et <code>RET</code> sont
fonctionnelles avant de passer à la suite. Par exemple, vous pouvez utiliser le code d'exemple
mentionné précédemment mais vous pouvez également écrire votre propre
programme à charger en RAM.</p>
</div>
<p>Une fois que vous êtes assurés que votre architecture est fonctionnelle, je vous propose deux exercices . </p>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Pour commencer je vous propose de programmer une généralisation des suites de Syracuse (ou de Collatz)</p>
<div class="arithmatex">\[\begin{eqnarray}
u(n+1) &amp;=&amp; f(u(n), a, b)\\
f(u, a, b) &amp;=&amp; \begin{cases} \frac{u}{2} &amp; \text{ si } u \text{ est pair } \\
a u + b &amp; \text{ sinon } \end{cases}
\end{eqnarray}\]</div>
<p>Je vous propose d'écrire un programme permettant de calculer les valeurs de cette suite en écrivant une routine pour la fonction "f".</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Ecrivez également une routine qui calcule la factorielle d'un nombre et utilisez le pour calculer <span class="arithmatex">\(8!\)</span>. Pour rappel : </p>
<div class="arithmatex">\[
fac(n) = \begin{cases} 1 &amp; \text{ si } n = 0\\
n fac(n-1) &amp; \text{ sinon } \end{cases}
\]</div>
<p>On voit donc que, si n est non nul, le résultat de fact(n) est calculé à partir du résultat de fact(n-1); nous avons donc ici une <strong>fonction récursive</strong>. </p>
</div></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 - Jérémy Fix –

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "toc.follow", "toc.integrate"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
      
        <script src="../js/seq_decode.js"></script>
      
        <script src="../js/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>